<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Eddie's 2025 | Official Ballot</title>
<style>
:root {
    --bg: #ffffff;
    --text: #000000;
    --accent: #000000;
    --border: #e0e0e0;
}

body { 
    font-family: 'Inter', -apple-system, sans-serif; 
    background: var(--bg); 
    color: var(--text);
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    justify-content: center;
}

.logo { max-width: 150px; margin-bottom: 20px; }

#ballot-box { width: 100%; max-width: 500px; text-align: center; }
.hidden { display: none !important; }

.progress-text { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; opacity: 0.6; }

.category-view h2 { font-size: 1.5rem; text-transform: uppercase; margin-bottom: 30px; letter-spacing: 1px; }

.film-option { 
    padding: 15px;
    margin: 10px 0;
    border: 1px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    transition: all 0.2s ease;
    text-align: left;
}

.film-option:hover { background: #f9f9f9; }
.film-option:has(input:checked) {
    border-color: var(--text);
    background: #000;
    color: #fff;
}

.film-option input { display: none; }

.nav-controls { margin-top: 40px; display: flex; justify-content: center; gap: 20px; }

.btn { 
    padding: 15px 40px; 
    font-size: 12px; 
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 2px;
    border: 2px solid var(--text); 
    background: var(--text); 
    color: white; 
    cursor: pointer;
    transition: 0.3s;
}

.btn:hover:not(:disabled) { background: white; color: var(--text); }
.btn:disabled { opacity: 0.3; cursor: not-allowed; }

#messages { margin-top: 20px; font-weight: bold; text-transform: uppercase; font-size: 0.8rem; }

#start-screen input { padding:10px; width: 80%; max-width:300px; margin-bottom:10px; border-radius:5px; border:1px solid #ccc; }
</style>
</head>
<body>

<img src="https://static.wixstatic.com/media/4510e9_bfe003d2401544b28aeeefef976db05a~mv2.png" alt="Logo" class="logo">

<div id="start-screen">
    <h1 style="letter-spacing: 5px; text-transform: uppercase;">The Eddie's 2025</h1>
    <p>Enter your email to cast your vote:</p>
    <input type="email" id="voter-email" placeholder="you@example.com">
    <div id="email-msg" style="color:red; margin-bottom:20px;"></div>
    <p>Then cast your vote for the best in film.</p>
    <button id="start-btn" class="btn">Start Voting</button>
</div>

<div id="ballot-box" class="hidden">
    <div class="progress-text" id="progress">Category 1 of X</div>
    <div id="current-category-container"></div>
    
    <div class="nav-controls">
        <button id="next-btn" class="btn">Next &rarr;</button>
    </div>
    <div id="messages"></div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabase = createClient(
    'https://asrydhgpdlpocuapcvuf.supabase.co',
    'sb_publishable_KANIL3DCSWPFVyJjhJ4uYA_38LnWmCu'
);

let categories = [];
let films = [];
let currentStep = 0;
let userVotes = [];

const startScreen = document.getElementById('start-screen');
const ballotBox = document.getElementById('ballot-box');
const container = document.getElementById('current-category-container');
const progressText = document.getElementById('progress');
const nextBtn = document.getElementById('next-btn');
const msg = document.getElementById('messages');

async function loadData() {
    const [catRes, filmRes] = await Promise.all([
        supabase.from('categories').select('*').eq('active', true).order('id'),
        supabase.from('films').select('*').order('name')
    ]);
    categories = catRes.data;
    films = filmRes.data;
}

// Start Voting Button
document.getElementById('start-btn').addEventListener('click', async () => {
    const emailInput = document.getElementById('voter-email');
    const emailMsg = document.getElementById('email-msg');
    const email = emailInput.value.trim().toLowerCase();

    if (!email || !/\S+@\S+\.\S+/.test(email)) {
        emailMsg.textContent = "Please enter a valid email.";
        return;
    }

    // Check if email has already voted
    const { count } = await supabase.from('votes').select('*', { count: 'exact' }).eq('email', email);
    if (count > 0) {
        emailMsg.textContent = "This email has already voted. Only one ballot per email.";
        return;
    }

    emailMsg.textContent = "";
    document.getElementById('start-btn').disabled = true;
    document.getElementById('start-btn').textContent = "Loading...";

    await loadData();
    startScreen.classList.add('hidden');
    ballotBox.classList.remove('hidden');
    showCategory();
});

function showCategory() {
    const cat = categories[currentStep];
    progressText.textContent = `Category ${currentStep + 1} of ${categories.length}`;
    
    container.innerHTML = `
        <div class="category-view">
            <h2>${cat.name}</h2>
            <div id="options-list"></div>
        </div>
    `;

    const list = document.getElementById('options-list');
    films.forEach(film => {
        const label = document.createElement('label');
        label.className = 'film-option';
        label.innerHTML = `
            <input type="radio" name="vote" value="${film.id}">
            <span>${film.name}</span>
        `;
        list.appendChild(label);
    });

    window.scrollTo(0,0);
}

// Next Button Logic
nextBtn.addEventListener('click', async () => {
    const selected = document.querySelector('input[name="vote"]:checked');
    
    if (!selected) {
        msg.textContent = "Please select a film to continue.";
        return;
    }

    msg.textContent = "";

    userVotes.push({
        category_id: categories[currentStep].id,
        film_id: parseInt(selected.value),
        email: document.getElementById('voter-email').value.trim().toLowerCase()
    });

    if (currentStep < categories.length - 1) {
        currentStep++;
        showCategory();
        if (currentStep === categories.length - 1) {
            nextBtn.textContent = "Finalize Ballot";
        }
    } else {
        submitAllVotes();
    }
});

async function submitAllVotes() {
    nextBtn.disabled = true;
    nextBtn.textContent = "Submitting...";

    const { error } = await supabase.from('votes').insert(userVotes);

    if (error) {
        msg.textContent = "Error: " + error.message;
        nextBtn.disabled = false;
    } else {
        ballotBox.innerHTML = `
            <div style="border: 2px solid #000; padding: 40px;">
                <h2 style="text-transform: uppercase;">Ballot Cast</h2>
                <p>Your choices for The Eddie's 2025 have been recorded.</p>
            </div>
        `;
    }
}
</script>
</body>
</html>
