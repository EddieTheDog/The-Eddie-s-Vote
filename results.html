<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Eddie's 2025 Results</title>
<style>
body { font-family: Arial; background:#f7f7f7; padding:20px; }
h1 { text-align:center; margin-bottom:30px; }
.category { background:#fff; padding:15px; margin-bottom:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.category h2 { margin-top:0; }
.winner { font-weight:bold; font-size:1.1em; margin-bottom:10px; color:#007AFF; }
.film-votes { margin-left:15px; margin-bottom:5px; }
.tie { color:#FF4500; font-weight:bold; }
</style>
</head>
<body>
<h1>The Eddie's 2025 Results</h1>
<div id="categories-container"></div>

<script type="module">
window.onload = async () => {
  const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
  if (!window.supabase) {
    window.supabase = createClient(
      'https://asrydhgpdlpocuapcvuf.supabase.co',
      'sb_publishable_KANIL3DCSWPFVyJjhJ4uYA_38LnWmCu'
    );
  }
  const supabase = window.supabase;

  const categoriesContainer = document.getElementById('categories-container');

  const { data: categoriesData } = await supabase.from('categories').select('*').eq('active', true).order('id');
  const { data: filmsData } = await supabase.from('films').select('*').order('id');

  for (let category of categoriesData) {
    const categoryDiv = document.createElement('div');
    categoryDiv.className = 'category';
    categoryDiv.innerHTML = `<h2>${category.name}</h2>`;

    // Count votes for all films in this category
    let votesCount = [];
    for (let film of filmsData) {
      const { count } = await supabase.from('votes')
        .select('*', { count: 'exact' })
        .eq('category_id', category.id)
        .eq('film_id', film.id);
      votesCount.push({ filmName: film.name, votes: count });
    }

    // Find max votes
    let maxVotes = Math.max(...votesCount.map(v => v.votes));
    let winners = votesCount.filter(v => v.votes === maxVotes && maxVotes > 0);

    // Display winner or tie
    const winnerDiv = document.createElement('div');
    winnerDiv.className = 'winner';
    if (winners.length === 0) {
      winnerDiv.textContent = 'No votes yet';
    } else if (winners.length === 1) {
      winnerDiv.textContent = `Winner: ${winners[0].filmName} (${winners[0].votes} vote${winners[0].votes !== 1 ? 's' : ''})`;
    } else {
      winnerDiv.textContent = `Tie!`;
      winnerDiv.classList.add('tie');
    }
    categoryDiv.appendChild(winnerDiv);

    // Show all films with votes
    votesCount.forEach(v => {
      const filmDiv = document.createElement('div');
      filmDiv.className = 'film-votes';
      filmDiv.textContent = `${v.filmName}: ${v.votes} vote${v.votes !== 1 ? 's' : ''}`;
      categoryDiv.appendChild(filmDiv);
    });

    categoriesContainer.appendChild(categoryDiv);
  }
};
</script>
</body>
</html>
