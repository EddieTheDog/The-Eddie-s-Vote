<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Eddie's 2025 Voting</title>
<style>
body { font-family: Arial; background:#f7f7f7; padding:20px; }
h1 { text-align:center; }
.categories { margin:20px 0; }
.category { background:#fff; padding:15px; margin-bottom:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.category h2 { margin-top:0; }
.films { margin-left:15px; }
.film-option { margin:5px 0; }
button { padding:10px 20px; font-size:16px; margin-top:20px; border:none; background:#007AFF; color:white; border-radius:5px; cursor:pointer; }
button:hover { background:#005BBB; }
#messages { margin-top:20px; font-weight:bold; }
</style>
</head>
<body>
<h1>The Eddie's 2025 Voting</h1>
<div id="categories-container" class="categories"></div>
<button id="submit-votes-btn">Submit Votes</button>
<div id="messages"></div>

<script type="module">
window.onload = async () => {
  const { createClient } = await import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm');
  if (!window.supabase) {
    window.supabase = createClient(
      'https://asrydhgpdlpocuapcvuf.supabase.co',
      'sb_publishable_KANIL3DCSWPFVyJjhJ4uYA_38LnWmCu'
    );
  }
  const supabase = window.supabase;

  const categoriesContainer = document.getElementById('categories-container');
  const submitVotesBtn = document.getElementById('submit-votes-btn');
  const messagesDiv = document.getElementById('messages');

  const { data: categoriesData } = await supabase.from('categories').select('*').eq('active', true).order('id');
  const { data: filmsData } = await supabase.from('films').select('*').order('id');

  // Render categories with all films available for each
  for (let category of categoriesData) {
    const categoryDiv = document.createElement('div');
    categoryDiv.className = 'category';
    categoryDiv.innerHTML = `<h2>${category.name}</h2>`;

    const filmsDiv = document.createElement('div'); filmsDiv.className = 'films';
    for (let film of filmsData) {
      const filmOptionDiv = document.createElement('div');
      filmOptionDiv.className = 'film-option';
      filmOptionDiv.innerHTML = `<label><input type="radio" name="category-${category.id}" value="${film.id}"> ${film.name}</label>`;
      filmsDiv.appendChild(filmOptionDiv);
    }
    categoryDiv.appendChild(filmsDiv);
    categoriesContainer.appendChild(categoryDiv);
  }

  submitVotesBtn.addEventListener('click', async () => {
    const votes = [];
    messagesDiv.textContent = '';
    submitVotesBtn.disabled = true;

    const categoriesDivs = document.querySelectorAll('.category');
    for (let categoryDiv of categoriesDivs) {
      const radios = categoryDiv.querySelectorAll('input[type="radio"]');
      let selectedFilmId = null;
      radios.forEach(r => { if (r.checked) selectedFilmId = r.value; });
      if (!selectedFilmId) { messagesDiv.textContent = 'Please select a film for each category!'; submitVotesBtn.disabled = false; return; }
      const categoryId = parseInt(radios[0].name.split('-')[1]);
      votes.push({ category_id: categoryId, film_id: parseInt(selectedFilmId) });
    }

    for (let vote of votes) {
      await supabase.from('votes').insert([vote]);
    }

    messagesDiv.textContent = 'Thank you! Your votes have been submitted.';
  });
};
</script>
</body>
</html>
